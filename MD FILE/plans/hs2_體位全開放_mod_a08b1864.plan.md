---
name: HS2 體位全開放 Mod
overview: 以 BepInEx + Harmony 製作 Mod，僅放寬「角色狀態、成就、痛覺、脫力」等安全條件；不直接改遊戲 DLL。對 HS2 的任何更動都先備份、檔名含時間戳、不覆寫既有備份，最小化滾回風險與麻煩。
todos: []
isProject: false
---

# HS2 體位全開放 Mod 計畫

## 備份規則（必須遵守）

- **目的**：對 HS2 作任何更動都有風險，因此要**最小化滾回的風險與麻煩**，盡力在更動前備份好檔案。
- **觸發時機**：在遊戲目錄（如 `D:\hs2`）內**新增、覆寫、刪除任何檔案之前**，若該路徑上已有檔案會被覆寫或取代，先備份該既有檔案。
- **備份檔名**：`{原檔名}.backup_{yyyyMMdd_HHmmss}`，例如 `SomePlugin.dll.backup_20250226_143052`。時間戳為「該次備份當下」的時間點。
- **禁止覆寫**：同一檔案每次備份都使用新的時間戳，既有備份檔絕不覆寫，以便出問題時可依時間點還原。
- **集中存放**：建議將備份放在該目錄下的 `Backup` 子資料夾（如 `D:\hs2\BepInEx\plugins\Backup\`），檔名仍含時間戳。

本方案**不直接修改** `Assembly-CSharp.dll`，僅在 `BepInEx\plugins` 新增 plugin DLL；若日後覆寫或更新該 plugin，仍須先備份既有 plugin 再覆寫。

## 目標

改寫遊戲邏輯，讓**在不會當機、不異常**的前提下，盡量多的體位隨時可選。做法是只放寬「安全」的檢查，**不**放寬可能導致 null 引用或缺少資源的檢查。

## 安全 vs 危險的條件


| 條件                                                 | 放寬後風險                                                   | 建議      |
| -------------------------------------------------- | ------------------------------------------------------- | ------- |
| **人數**（Item1==4/5 需第二女，6 需第二男）                     | 選 3P/雙男體位時會用到 `chaFemales[1]`/`chaMales[1]`，若為 null 易當機 | **不放寬** |
| **EventNo==19**、**CheckEventLimit**、**CheckPlace** | 場所/事件不符可能導致座標或資源錯誤                                      | **不放寬** |
| **CheckAppendEV**（追加事件/DLC）                        | 可能載入不存在的資源                                              | **不放寬** |
| **角色狀態（nStatePtns）**                               | 僅控制列表顯示，不影響物件存在與否                                       | **放寬**  |
| **成就（Achievments）**                                | 僅控制是否顯示                                                 | **放寬**  |
| **痛覺（LimitResistPain + lstSystem）**                | 僅隱藏列表                                                   | **放寬**  |
| **脫力／倒地（nDownPtn、nFaintnessLimit）**                | 僅控制列表，選錯頂多表現怪異                                          | **放寬**  |


## 實作方式

- **不直接改遊戲 DLL**：使用 **BepInEx 5** + **Harmony**，在執行時對 `HSceneSprite` 的下列方法做 patch，僅放寬「狀態／成就／痛覺／脫力」；人數、場所、事件、追加事件檢查仍由原方法執行。
- **Patch 目標**（[HSceneSprite.cs](d:\HS4\dll_decompiled\HSceneSprite.cs)）：
  - `CheckMotionLimit`（約 1847–1984 行）：選單列出體位
  - `CheckMotionLimitRecover`（約 1980–2101 行）：脫力恢復時可選體位
  - `CheckAutoMotionLimit`（約 2103–2175 行）：自動／隨機選體位時
- **做法**：以 Harmony **Postfix** 為例——先讓原方法執行；若回傳 `false`，再以自訂邏輯判斷「是否僅因 nStatePtns／成就／痛覺／脫力而失敗」（其餘人數、CheckPlace、CheckEventLimit、CheckAppendEV 仍須通過），若是則改回傳 `true`，否則維持 `false`。不 patch `CheckMotionLimitAppend3P`。
- **部署**：編譯產生的 plugin DLL 放到 `D:\hs2\BepInEx\plugins\`。若該路徑已存在同名 DLL，依備份規則先備份再覆寫。

## 專案結構與實作要點

- **專案位置**：可在 d:\HS4 下新增 BepInEx plugin 專案（例如 `HS2UnlockAllPoses`），編譯後手動複製到遊戲的 `BepInEx\plugins`。
- **檔案**：主 plugin 類別（`[BepInPlugin]`、`Harmony.PatchAll()`）、Harmony patch 類別（對 `CheckMotionLimit`、`CheckMotionLimitRecover`、`CheckAutoMotionLimit` 做 Postfix，共用的「僅因可放寬條件而失敗」判斷）。
- **參考**：BepInEx 5、Harmony、UnityEngine、遊戲的 `Assembly-CSharp.dll`（如 `D:\hs2\HS2_Data\Managed\Assembly-CSharp.dll`）。
- **邏輯**：原方法順序為 人數 → EventNo==19 → CheckEventLimit → CheckPlace → 成就 → nStatePtns → 脫力 → 痛覺 → CheckAppendEV。Postfix 僅在原方法回傳 false 時，確認「人數／場所／事件／CheckAppendEV 在邏輯上仍通過」，且失敗原因落在成就／狀態／脫力／痛覺，才改為 true。

## 測試建議

- 單人、雙人、EventNo 一般與 19、脫力前後、不同場所各測一次，確認：  
  - 列表體位變多（尤其不同狀態下都能看到原本被鎖的體位）。  
  - 不選 3P/雙男體位時不會當機；選 3P 時僅在已有第二人時選。
- 若有 DLC/追加事件專用體位，確認未解鎖時仍不會因放寬而載入缺失資源（CheckAppendEV 未放寬則應無虞）。

## 小結

- **備份**：對 HS2 任何更動都先備份受影響的既有檔案，檔名 `{原檔名}.backup_{yyyyMMdd_HHmmss}`，不覆寫既有備份，以最小化滾回風險與麻煩。
- **做**：BepInEx 5 + Harmony，patch `CheckMotionLimit`、`CheckMotionLimitRecover`、`CheckAutoMotionLimit`，只放寬 nStatePtns、成就、痛覺、脫力；不直接改遊戲 DLL。
- **不做**：放寬人數、場所、事件、追加事件檢查，以降低當機與異常風險。

