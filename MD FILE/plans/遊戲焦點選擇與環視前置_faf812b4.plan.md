---
name: 遊戲焦點選擇與環視前置
overview: 釐清遊戲內視角焦點/距離/角度/遮蔽（反編譯 DLL），並定義單一 BepInEx 插件產品規格：環視（六焦點、80% 距離、45° 角度、360 旋轉、四階段衣物、熱鍵）、興奮劑量表改動（有動即命中、滿 N 秒觸發、點滑鼠馬上變）、熱鍵相鄰預設（Ctrl+Shift+O / P）。
todos: []
isProject: false
---

# 遊戲焦點選擇方式整理（H 場景視角）

依據 [dll_decompiled](d:\HS4\dll_decompiled) 內反編譯程式碼，遊戲內視角焦點主要有以下幾種來源與操作方式。

---

## 1. 焦點在引擎裡的表示方式

- **焦點 = 相機看向的點**：在 `BaseCameraControl_Ver2` 裡由 `**CamDat.Pos`**（世界或 transBase 局部座標）表示，相機位置則由 `CamDat.Pos` + 旋轉與 `**CamDat.Dir`**（其中 `**Dir.z**` 為負值，表示相機到焦點的距離）計算出來。
- **座標基準**：H 場景中會呼叫 `GlobalMethod.setCameraBase(ctrlFlag.cameraCtrl, chaFemalesTrans[0])`，因此 `**transBase`** 固定為**第一女主角的根 Transform**。相機的 `CamDat.Pos` 會以 transBase 為基準做轉換（例如鍵盤焦點時用 `transBase.InverseTransformPoint`）。

---

## 2. 焦點選擇方式（三種）

### 2.1 姿勢／動畫綁定的預設焦點（主要來源）

- 每個姿勢／動畫有一欄 `**nameCamera`**（例如 `"01"`, `"08"`, `"13"` 等）。
- 載入姿勢時會呼叫：
  - `GlobalMethod.loadCamera(ctrlFlag.cameraCtrl, hSceneManager.strAssetCameraList, _info.nameCamera)`  
  - 或 `loadResetCamera(...)`（不強制重置時）。
- 對應資源路徑為 `**list/h/camera/`**（見 [AssetBundleNames.cs](d:\HS4\dll_decompiled\AssetBundleNames.cs)），讀取的是該姿勢預設的 Pos, Dir, Rot, Fov（文字或二進位），也就是**該姿勢的預設機位與焦點**。
- **結論**：焦點沒有在 UI 上「選擇」，而是**隨姿勢／動畫綁定在 list/h/camera/ 的預設資料裡**；切姿勢就換一組焦點與機位。

### 2.2 鍵盤快速切換焦點（Q / W / E）

- 在 [GlobalMethod.CameraKeyCtrl](d:\HS4\dll_decompiled\GlobalMethod.cs) 中，H 場景會依按鍵把焦點設到**女主角身體骨骼**上：
  - **Q**：頭部 → `cf_J_Head`
  - **W**：胸部 → `cf_J_Mune00`
  - **E**：骨盆 → `cf_J_Kokan`
- 若有**第二位女主角**，按住 **Shift + Q/W/E** 會對 **第二人** 的對應骨骼做同樣設定（`_Females[1]`）。
- 實作方式：取得對應骨骼 `Transform`，再用 `**_ctrl.TargetPos = _ctrl.transBase.InverseTransformPoint(transform.position)`** 寫入焦點（transBase 局部座標）。

也就是說，**遊戲內建「可選焦點」只有這三種身體部位 × 第 1 或第 2 女主角**。環視插件採用與 QWE 相容的 **六個焦點**：第一女角頭/胸/骨盆（Q/W/E）+ 第二女角頭/胸/骨盆（Shift+Q/W/E）；若僅有一人則只使用前三個。

### 2.3 程式／插件可用的焦點設定方式

- **設定焦點位置**：  
  - 直接寫入 `ctrlFlag.cameraCtrl.TargetPos`（Vector3，需為 transBase 局部座標，與鍵盤 Q/W/E 一致）。  
  - 或透過 `BaseCameraControl_Ver2.TargetSet(Transform target, bool isReset)` / `FrontTarget(Transform target, bool isReset, float dir)`，傳入任意 **Transform**（例如某骨骼、女主角根節點、或自建空物件），會把該 Transform 的 position 設為焦點並更新相機朝向與距離。
- **設定基準**：`GlobalMethod.setCameraBase(ctrlFlag.cameraCtrl, transform)` 可改變 transBase（目前遊戲只在切姿勢/場景時設成 `chaFemalesTrans[0]`）。
- **距離**：由 `CamDat.Dir.z`（負值）與 FOV 控制；玩家可用滑鼠滾輪、Home/End 等調整；插件亦可直接改 `CameraControl_Ver2` 的內部資料或封裝 API。

---

## 3. 距離與角度的設定（BaseCameraControl_Ver2 / CameraControl_Ver2）

### 3.1 距離（相機到焦點）

- **儲存**：`CamDat.Dir.z`，為**負值**，絕對值即為「焦點到相機」的距離。
- **操作**：
  - 滑鼠滾輪：`InputMouseWheelZoomProc()` 用 `zoomSpeed`（預設 5）改變 `Dir.z`，且 `Dir.z = Mathf.Min(0f, CamDat.Dir.z)`，即只能拉遠、不能為正。
  - 鍵盤：Home / End 在 `InputKeyProc()` 中加減 `Dir.z`（`keySpeed * Time.deltaTime`）。
- **限制**（[BaseCameraControl_Ver2.cs](d:\HS4\dll_decompiled\BaseCameraControl_Ver2.cs)）：
  - `isLimitDir == true` 時：`CamDat.Dir.z = Mathf.Clamp(CamDat.Dir.z, -limitDir, 0f)`，預設 **limitDir = 10**，即距離上限 10 單位。
  - 未開 limit 時，距離僅受 `Min(0, Dir.z)` 約束，理論上可很大。
- **小結**：插件可讀寫 `CamDat.Dir.z`（或透過現有 API）做「亂數距離」；若需範圍可依 limitDir 或自訂 min/max 距離。

### 3.2 角度（朝向與 FOV）

- **朝向**：`CamDat.Rot`（歐拉角），對應相機旋轉；`CamDat.Rot.y` 為水平（繞上軸），環繞即改此值。
- **視野**：`CamDat.Fov`（度），直接對應 `thisCamera.fieldOfView`。
- **限制**：
  - **limitFovMin = 10**、**limitFov = 40**（度）；鍵盤 `=` / `]` 會用 deltaTime 加減 FOV 並 Clamp 在此區間。
  - 旋轉無內建上下限，僅在觸控時有 y 的處理。
- **小結**：環視可只改 `Rot.y`；若要「亂數角度」可動 `Rot.x`（俯仰）或 FOV。

---

## 4. 遮蔽偵測（視角與女角之間有無障礙物）

### 4.1 H 場景現況：無「相機─焦點」遮蔽偵測

- H 場景使用的是 **CameraControl_Ver2**（繼承 BaseCameraControl_Ver2），**沒有**掛載 `CollisionCamera` 或任何從相機到焦點做 Raycast 的邏輯。
- 其 **VanishProc**（[CameraControl_Ver2.cs](d:\HS4\dll_decompiled\CameraControl_Ver2.cs)）：相機本體帶有一個 **CapsuleCollider**（viewCollider，trigger）。當相機**進入**場景中某個 trigger（名稱對應 `lstMapVanish` 的 nameCollider）時，會**隱藏**該區塊的場景物件（牆、地板等），避免「人在牆內」穿幫。這是「相機在區域內 → 隱藏該區」而非「相機與角色之間有障礙物 → 偵測遮蔽」。

### 4.2 本體中已有的遮蔽處理範例（CollisionCamera）

- [CollisionCamera.cs](d:\HS4\dll_decompiled\CollisionCamera.cs) 使用 **BaseCameraControl**（舊版相機），實作的是「相機到焦點」的遮蔽處理：
  - 從 `transform.position` 到目標（`targetObj` 或 `TargetPos`）做 **Physics.RaycastAll**。
  - 對命中且 tag 為 **"CollDels"** 的物體，將其 **Renderer.enabled = false**（讓介於相機與焦點之間的障礙物暫時不畫出來）。
- H 場景用的是 Ver2 相機，**沒有**使用 CollisionCamera，因此**目前無法偵測或處理「視角與女角之間的遮蔽」**。

### 4.3 插件若要支援遮蔽偵測

- **做法**：在插件內取得 `CameraControl_Ver2` 的相機位置與當前焦點（例如 `transBase.TransformPoint(CamDat.Pos)`），每幀或每隔幾幀做一次 **Physics.Raycast**（或 RaycastAll）從相機到焦點。
  - 若 hit 到障礙物：可選擇 (1) 隱藏該物 Renderer、(2) 拉近相機到 hit 點、(3) 僅標記「被遮蔽」供環視邏輯跳過或重選焦點等。
- **注意**：障礙物需有 Collider 且 layer 不被忽略；若場景物件沒有 tag "CollDels" 或未預期被射線打到，需在插件內自訂 layer/tag 或白名單。

---

## 5. 與「環繞女主角 360° 環視」的關係

- **焦點候選**：採用 **六個 QWE 相容焦點**（第一女角頭/胸/骨盆 + 第二女角頭/胸/骨盆）；或可再加女主角根節點、自訂骨骼等；皆可透過 **TargetPos**（transBase 局部座標）或 **TargetSet / FrontTarget** 設定。
- **旋轉**：已有 `**CameraControl_Ver2.autoCamera(float _fSpeed)`**（[CameraControl_Ver2.cs](d:\HS4\dll_decompiled\CameraControl_Ver2.cs) 約 147–150 行），會依 `_fSpeed * Time.deltaTime` 改變 CamDat.Rot.y（水平旋轉），可作為「每 X 秒一圈」的環繞基礎；需在插件裡**持續驅動**並配合焦點與距離。
- **距離與隨機**：讀寫 **CamDat.Dir.z**（距離）、**CamDat.Fov**（可選）；在「每 Y 秒後」亂數選擇六焦點之一與距離（可參考 limitDir 或自訂範圍），再重新開始環視。
- **遮蔽（可選）**：若要避免「鏡頭被擋」，可在插件內從相機到焦點做 **Physics.Raycast**，依 hit 決定拉近距離或隱藏障礙物（見 4.3）。

---

## 6. 簡表：遊戲內焦點選擇方式


| 方式     | 說明                                                                                    |
| ------ | ------------------------------------------------------------------------------------- |
| 姿勢綁定   | 每個姿勢的 `nameCamera` 對應 list/h/camera/ 的預設 Pos/Dir/Rot/Fov，焦點含在內                        |
| 鍵盤 Q   | 焦點 = 第一女角頭部 (cf_J_Head)；Shift+Q = 第二女角頭部                                              |
| 鍵盤 W   | 焦點 = 第一女角胸部 (cf_J_Mune00)；Shift+W = 第二女角胸部                                            |
| 鍵盤 E   | 焦點 = 第一女角骨盆 (cf_J_Kokan)；Shift+E = 第二女角骨盆                                             |
| 插件 API | TargetPos、TargetSet(Transform)、FrontTarget(Transform)、setCameraBase、autoCamera(float) |


若以 BepInEx 插件實作環視，下一階段可從：取得 `CameraControl_Ver2`、在 Update 裡驅動 `autoCamera` 或自算 Rot.y、定期在六個 QWE 焦點與距離/角度範圍內亂數重設、以及可選的 Raycast 遮蔽處理 開始設計具體步驟與參數（X、Y、距離 min/max、FOV 範圍等）。

---

# 環視插件產品規格與變數定義（實作用）

以下為本對話中敲定的名詞、階段定義與可設定變數，供 BepInEx 插件與選單實作對齊。

---

## 7. 焦點（Focus）


| 代號  | 英文變數 / 列舉           | 骨骼          | 說明     |
| --- | ------------------- | ----------- | ------ |
| 頭部  | `FocusKind.Head`    | cf_J_Head   | 第一女角頭  |
| 胸部  | `FocusKind.Chest`   | cf_J_Mune00 | 第一女角胸  |
| 骨盆  | `FocusKind.Pelvis`  | cf_J_Kokan  | 第一女角骨盆 |
| 頭部2 | `FocusKind.Head2`   | cf_J_Head   | 第二女角頭  |
| 胸部2 | `FocusKind.Chest2`  | cf_J_Mune00 | 第二女角胸  |
| 骨盆2 | `FocusKind.Pelvis2` | cf_J_Kokan  | 第二女角骨盆 |


- **單人／雙人於開始環視時決定**：使用者按熱鍵**開始環視**當下，讀取當時場景狀態（例如 `chaFemales`、第二女角是否存在），據此決定本輪環視為單人或雙人；若為單人則**不提供** Head2 / Chest2 / Pelvis2，亂數時也只從 Head / Chest / Pelvis 中選。
- 選單變數建議：`DefaultFocus`（預設焦點）。

---

## 8. 距離（Distance）— 與焦點連動的 80% 畫面構圖

所有距離預設皆為**畫面 80% 為該構圖**（頭部／上半身／全身…依檔位）。距離預設**與當前焦點連動**：四檔依序為「焦點部位 → 半身 → 單人全身 → 雙人全身」，其中「焦點部位」與「半身」隨焦點不同而不同。


| 當前焦點     | 第 1 檔（焦點部位） | 第 2 檔（半身） | 第 3 檔 | 第 4 檔 |
| -------- | ----------- | --------- | ----- | ----- |
| 頭部 / 頭部2 | 頭部          | 上半身       | 單人全身  | 雙人全身  |
| 胸部 / 胸部2 | 胸部          | 上半身       | 單人全身  | 雙人全身  |
| 骨盆 / 骨盆2 | 骨盆          | 下半身       | 單人全身  | 雙人全身  |


- **列舉建議**：`DistancePreset.FocalPart`（焦點部位）、`HalfBody`（上半身/下半身由焦點決定）、`FullBody`、`TwoPersonFull`。
- **單人／雙人於開始環視時決定**（同 §7）；若該次為單人，**不提供「雙人全身」**（亂數時不選此檔）。
- **第一次旋轉不改變**：第一次按熱鍵啟動環視時，**完全不重算**，完全沿用當下鏡頭（焦點、角度、距離、FOV）。**僅在「改變焦點、角度或姿勢」時**才重算距離（及 H_subject）；畫面高度規則：啟動時用當下高度，切換時用該次焦點對應高度。
- 公式：`d = H_subject / (f * 2 * tan(FOV_v/2))`，**f = 0.80**（80% 畫面）；FOV 用當前相機。選單變數建議：`DistancePreset`（四檔之一，實際對應的 H_subject 由當前焦點決定）。

---

## 9. 角度（Angle）— 每 45° 一檔（取消 225°、270°、315°）


| 代號      | 列舉 / 值                        | 度數                  |
| ------- | ----------------------------- | ------------------- |
| 0°～180° | `AnglePreset.Deg0` … `Deg180` | 0, 45, 90, 135, 180 |


僅保留以上五檔；**225°、270°、315° 已取消**。選單變數建議：`StartAnglePreset` 或直接存 `float StartAngleDeg`。

---

## 10. 360 旋轉（Orbit）

- 攝影機向心迴轉：先轉 360° 再**逆方向**轉回起點。
- 選單變數：`**OrbitTimePer360`**（秒）— 單向 360° 或單向「回程」各需時間（即 360_RT）。

---

## 11. 連續 360 旋轉（Continuous Orbit）


| 名詞          | 英文變數建議                               | 說明                                    |
| ----------- | ------------------------------------ | ------------------------------------- |
| 幾次 360 後亂數  | `OrbitCountBeforeRandom`（n）          | 完成 n 次「去+回」後亂數角度與焦點                   |
| 幾次 360 後換姿勢 | `OrbitCountBeforePoseChange`（n_Over） | 達 n_Over 次後換姿勢（僅在改姿勢模式）               |
| 是否改姿勢       | `ChangePoseOnCycle`                  | true = 達 n_Over 後換姿勢；false = 不改姿勢、一直轉 |


**換姿勢規則**：姿勢來源為**全部**可選姿勢；**排除當前姿勢**；**不可重複**（每次從「全部扣除當前」中亂數選下一個，若僅一姿勢則不換或維持）。

---

## 12. 衣物階段（Clothes）— 四階段

每完成 **1 次** 360 旋轉（去+回），依序進一階段（可選增加或減少方向）。


| 階段  | 英文列舉                           | 中文               | 遊戲槽位對應（ChaFileDefine.ClothesKind 0～7）                  |
| --- | ------------------------------ | ---------------- | ------------------------------------------------------ |
| 0   | `ClothesStage.Full`            | 穿著（正常）           | 全部 state = 0                                           |
| 1   | `ClothesStage.Half`            | 半脫               | 上/下相關槽位 state = 1（objTopHalf / objBotHalf）             |
| 2   | `ClothesStage.KeepAccessories` | 脫掉但保留飾品、鞋襪、panst | 0,1,2,3 → 2；4,5,6,7（gloves, panst, socks, shoes）→ 保留 0 |
| 3   | `ClothesStage.FullOff`         | 脫掉               | 全部 0～7 → state = 2                                     |


槽位對照：0 top, 1 bot, 2 inner_t, 3 inner_b, 4 gloves, 5 panst, 6 socks, 7 shoes。  
**套用對象**：**全部人物**（第一女角、第二女角若有則一併套用同一階段）。  
選單變數建議：`ClothesStageCount = 4`、`ClothesDirection`（1=增加 / -1=減少）、`ClothesChangeEnabled`。

---

## 13. 熱鍵（Hotkey）

- **兩顆熱鍵相鄰**，預設一組、選單內皆可自訂：
  - **環視 開／關**：`HotkeyStartOrbit`，預設 **Ctrl + Shift + O**（Toggle；再按一次即停止）。
  - **開啟選單**：`HotkeyOpenMenu`，預設 **Ctrl + Shift + P**（O 與 P 相鄰）。
- **第一次按環視熱鍵時**：**完全不改變**鏡頭設定，完全用當下視角（Rot、TargetPos、Dir.z、FOV）作為起始，依 OrbitTimePer360 開始向心迴轉；僅在之後**改變焦點、角度或姿勢**時才重算距離等。

---

## 14. 停止方式（Stop Mode）

環視劇本何時結束（除手動按熱鍵停止外）— 選單可選下列之一：


| 選項         | 英文列舉 / 變數                           | 說明                                                            |
| ---------- | ----------------------------------- | ------------------------------------------------------------- |
| 手動停止       | `StopMode.ManualOnly`               | 僅能由使用者按熱鍵停止；無自動停止                                             |
| 同一姿勢若干次後停止 | `StopMode.StopAfterSamePoseCycles`  | 同一姿勢連續進行 N 次 360 旋轉後自動停止；需參數 `StopAfterSamePoseCycleCount`（N） |
| 同一姿勢不停止    | `StopMode.SamePoseNoStop`           | 不改姿勢、同一姿勢一直轉，不自動停止（僅手動停止）                                     |
| 換幾次姿勢後停止   | `StopMode.StopAfterPoseChangeCount` | 累計換過 N 次姿勢後自動停止；需參數 `StopAfterPoseChangeCount`（N）             |
| 不斷換姿勢不停止   | `StopMode.NeverStop`                | 會持續換姿勢，永不自動停止（僅手動停止）                                          |


- **「同一姿勢」定義**：**未觸發換姿勢**的連續區間；自上次觸發換姿勢到下次觸發前皆算同一姿勢。選單變數建議：`StopMode`（列舉五選一）；若選「同一姿勢若干次後停止」或「換幾次姿勢後停止」，另提供 `StopAfterSamePoseCycleCount` / `StopAfterPoseChangeCount`（int）。

---

## 15. 環視進行中與設定存檔

- **環視進行中**：玩家**仍可控制**鏡頭（滑鼠等）；插件只持續驅動旋轉，不鎖定相機輸入。
- **設定存檔**：選單內變數**自動存檔**（例如 BepInEx ConfigEntry 寫入設定檔），下次啟動遊戲沿用。
- **選單入口**：由 `HotkeyOpenMenu` 開啟（預設 Ctrl+Shift+P，可自訂）。

---

## 16. 興奮劑量表改動（同一插件內）

與環視功能同屬**同一 BepInEx 插件**。以下行為皆在 H 場景有效：

- **有動就當命中**：當 **ctrlFlag.speed > 0**（有在播、有在動）時，**一律視為命中**（例如 Harmony patch `FeelHit.isHit` 在 speed > 0 時回傳 true），興奮劑量表（feel_f / feel_m）會上升；speed = 0（暫停）時不強制命中。
- **觸發改變可設「滿幾秒後」**：興奮劑滿（例如 feel_f ≥ 1）時，**自動觸發**改為「滿了之後再持續滿 **N 秒**才觸發」；**N 可選單設定**，**預設 0**（滿就觸發），**範圍建議 0～10 秒**。
- **點選滑鼠一定馬上觸發**：玩家以滑鼠點選（絕頂／中出／外出等按鈕）時，**不套用 N 秒延遲**，一律**立刻觸發**改變。

選單變數建議：`ExcitementTriggerDelaySeconds`（float，預設 0，範圍 0～10）。

---

## 17. 已定與待後續

- **已定**：單人／雙人＝**開始環視時**讀取場景狀態（如 chaFemales）決定。  
- **已定**：**環繞時遮蔽**＝可選「隱藏相機與焦點間障礙物」；Raycast **每 2 秒一次**；選單開關（如 `HideObstaclesDuringOrbit`）；停止環視時還原所有被隱藏 Renderer。  
- **已定**：畫面高度＝啟動時用當下高度，**改變焦點／角度／姿勢時**用該次焦點對應高度；**第一次旋轉不重算**。  
- **已定**：「同一姿勢」＝未觸發換姿勢之連續區間；FOV 用當前相機。

---

## 18. 選單可設變數總表


| 分類     | 變數名建議                            | 型別               | 說明                                               |
| ------ | -------------------------------- | ---------------- | ------------------------------------------------ |
| 焦點     | DefaultFocus                     | FocusKind        | 預設焦點；無雙人時僅提供頭/胸/骨盆三選一                            |
| 距離     | DistancePreset                   | DistancePreset   | 與焦點連動：焦點部位/半身/單人全身/雙人全身；無雙人時不提供雙人全身              |
| 角度     | StartAnglePreset / StartAngleDeg | enum / float     | 起始角度（45° 一檔）                                     |
| 360 旋轉 | OrbitTimePer360                  | float            | 單向 360° 秒數（360_RT）                               |
| 連續     | OrbitCountBeforeRandom           | int              | n：幾次 360 後亂數角度/焦點                                |
| 連續     | OrbitCountBeforePoseChange       | int              | n_Over：幾次 360 後換姿勢                               |
| 連續     | ChangePoseOnCycle                | bool             | 是否在 n_Over 後換姿勢                                  |
| 衣物     | ClothesChangeEnabled             | bool             | 是否每 360 完成切換衣物階段                                 |
| 衣物     | ClothesDirection                 | int              | 1=增加 / -1=減少                                     |
| 熱鍵     | HotkeyStartOrbit                 | KeyboardShortcut | 環視開／關 Toggle，預設 **Ctrl+Shift+O**；首次按＝完全不改變、用當下鏡頭 |
| 熱鍵     | HotkeyOpenMenu                   | KeyboardShortcut | 開啟選單，預設 **Ctrl+Shift+P**（與 O 相鄰）                 |
| 停止方式   | StopMode                         | StopMode         | 手動／同姿勢 N 次後停／同姿勢不停／換姿勢 N 次後停／永不停                 |
| 興奮劑    | ExcitementTriggerDelaySeconds    | float            | 滿了後幾秒才自動觸發（0～10，預設 0）；點滑鼠仍立刻觸發                   |
| 停止參數   | StopAfterSamePoseCycleCount      | int              | 同一姿勢幾次 360 後停止（StopMode 為同姿勢若干次後停時用）             |
| 停止參數   | StopAfterPoseChangeCount         | int              | 換幾次姿勢後停止（StopMode 為換姿勢 N 次後停時用）                  |


- 使用者可透過**選單**設定以上變數；設定**自動存檔**。環視與興奮劑改動為**同一插件**。
- 環視進行中玩家**仍可控制**鏡頭；衣物階段套用**全部人物**；換姿勢為**全部姿勢、排除當前、不可重複**。僅在**改變焦點、角度或姿勢**時重算距離；第一次旋轉不改變鏡頭。

