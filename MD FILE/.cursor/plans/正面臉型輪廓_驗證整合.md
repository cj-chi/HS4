# 正面臉型輪廓計劃：驗證整合（HS2CharEdit --validate）

本文件為**補充**：在實作「正面臉型輪廓算法」產出卡片後，改以 **HS2CharEdit 的 `--validate <card.png>`** 做驗證，取代或輔助現有 Python 的 `read_face_params` + `check_chareditor_limits`。

---

## 前提

- 你會在 **HS2CharEdit** 專案中實作命令列模式：  
  `--validate <card.png>`  
  以編輯器本尊的讀取邏輯驗證卡片，輸出與現有 Python 對齊的 **JSON 報告** 與 **exit code**（見 [hs2charedit_agent_驅動驗證_80878563.plan.md](hs2charedit_agent_驅動驗證_80878563.plan.md)）。
- 本側（正面臉型輪廓 / run_poc / optimize_contour）**做好以後**，用該驗證做為產卡後的最終檢查。

---

## 整合方式

1. **產卡流程結束後呼叫驗證**  
   - 在寫入角色卡後（例如 [write_face_params_to_card](d:\HS4\write_face_params_to_card.py) 寫完 `args.output_card`），  
     執行：  
     `HS2CharEdit.exe --validate "<output_card.png>"`  
   - 可選：指定輸出 JSON 路徑（若 HS2CharEdit 支援第三參數），例如與卡片同名的 `.chareditor_check.json`，以與現有 [run_poc](d:\HS4\run_poc.py) 產物一致。

2. **解讀結果**  
   - **Exit code**：0 = 驗證通過（讀取成功且 face 值在編輯器預期範圍內），非 0 = 失敗或超出範圍。  
   - **JSON 報告**：與現有 `.chareditor_check.json` 對齊（例如含 `chareditor_read`、`chareditor_in_range` / `chareditor_out_of_range`、或你約定的欄位），供 agent / run_poc 解析，必要時寫入同一份報告檔。

3. **Agent / run_poc 行為**  
   - 若以 **agent** 或 **run_poc** 驅動整段流程（照片 → 優化 → 寫卡 → 驗證）：  
     - 在寫卡後呼叫 `HS2CharEdit --validate <card.png>`；  
     - 若 exit code ≠ 0，可將該次 run 視為失敗並回報（或仍產卡但標記未通過驗證）；  
     - 若 exit code = 0，可視為「編輯器本尊驗證通過」，與現有 Python 檢查互補或取代。

4. **與現有 Python 檢查的關係**  
   - 目前 [run_poc.py](d:\HS4\run_poc.py) 在 `--output-card` 後用 [read_face_params_from_card](d:\HS4\read_face_params_from_card.py) + `check_chareditor_limits` 產出 `.chareditor_check.json`。  
   - HS2CharEdit --validate 上線後，可改為：  
     - **優先**：呼叫 `HS2CharEdit --validate`，直接使用其 JSON 與 exit code；  
     - **可選**：保留 Python 讀取做為對照或 fallback（例如 HS2CharEdit 未安裝時）。

---

## 介面假設（與 Python 對齊）

為讓 agent / run_poc 能解析 HS2CharEdit 的輸出，建議 JSON 至少包含與現有 [run_poc 的 check_report](d:\HS4\run_poc.py) 可對齊的欄位，例如：

- `chareditor_read`：編輯器讀到的 face 欄位（鍵名與 Python 端一致，如 headWidth, eyeVertical, eyeSpacing, …）。
- `chareditor_in_range` / `chareditor_out_of_range` 或等價的「在範圍內 / 超出範圍」列表。
- （可選）`chareditor_limits`：min/max（如 -100, 200）。

這樣 `optimize_contour` 或 run_poc 寫卡後，只需呼叫一次 `--validate`，再根據 exit code 與上述 JSON 決定是否通過驗證，無需重複實作讀卡邏輯。

---

## 實作順序建議（更新）

在「正面臉型輪廓算法」計劃的**最後一步**（寫卡之後）加上：

1. 解析 HS2CharEdit 可執行檔路徑（專案內 `HS2CharEdit/bin/...` 或環境變數）。
2. 執行 `HS2CharEdit.exe --validate "<產出的 card.png>"`，可選寫入同名的 `.chareditor_check.json`。
3. 讀取 exit code；若為 0 則視為驗證通過，否則標記失敗並可將 JSON 報告寫入日誌或產物目錄。
4. Agent / run_poc 在自動化流程中依此決定是否通過或回報錯誤。

這樣「做好以後，用 HS2CharEdit --validate 去驗證」即落實於同一流程中。
