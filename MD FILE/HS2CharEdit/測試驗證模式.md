# HS2CharEdit 驗證模式測試說明

## 1. 先建置

```powershell
cd d:\HS4\HS2CharEdit
dotnet build HS2CharEdit\HS2CharEdit.csproj -c Release
```

執行檔位置：`HS2CharEdit\bin\Release\net6.0-windows7.0\HS2CharEdit.exe`

---

## 2. 測試一：無參數（一般 GUI）

雙擊 `HS2CharEdit.exe` 或：

```powershell
& "d:\HS4\HS2CharEdit\HS2CharEdit\bin\Release\net6.0-windows7.0\HS2CharEdit.exe"
```

**預期**：主視窗正常開啟，可開檔/存檔，行為與改動前一致。

---

## 3. 測試二：`--validate` 驗證一張卡

任選一張 HS2 角色卡 PNG（例如遊戲 `UserData\chara\female\` 下的卡，或你用 `run_poc.py --output-card` 產出的卡）：

```powershell
$exe = "d:\HS4\HS2CharEdit\HS2CharEdit\bin\Release\net6.0-windows7.0\HS2CharEdit.exe"
$card = "D:\path\to\your\card.png"   # 改成你的卡路徑
& $exe --validate $card
echo "Exit code: $LASTEXITCODE"
```

**預期**：

- 不會跳出視窗。
- 在卡片**同目錄**下產生 `卡名.chareditor_check.json`（例如 `card.chareditor_check.json`）。
- **Raw 布局的卡**：臉部數值在 -100～200 內時，exit code 為 **0**，JSON 裡 `chareditor_values_in_range` 為 `true`。
- **MessagePack 卡** 或數值超出範圍：exit code 為 **1**，JSON 裡會有 `chareditor_out_of_range`，`chareditor_values_in_range` 為 `false`。

檢查產生的 JSON：

```powershell
Get-Content "D:\path\to\your\card.chareditor_check.json" | ConvertFrom-Json | ConvertTo-Json -Depth 5
```

或用文字編輯器直接打開 `卡名.chareditor_check.json` 查看 `chareditor_read`、`chareditor_in_range`、`chareditor_out_of_range`。

---

## 4. 測試三：指定輸出 JSON 路徑

```powershell
& $exe --validate "D:\path\to\card.png" "D:\output\report.json"
```

**預期**：報告寫入 `D:\output\report.json`，不寫在卡旁邊。

---

## 5. 測試四：與 run_poc 一起跑（端到端）

先用 run_poc 產出一張卡，再用編輯器驗證：

```powershell
cd d:\HS4
# 需有 照片 + 一張基底卡
python run_poc.py some_photo.jpg base_card.png --output-card out_card.png
# 用 HS2CharEdit 驗證產出的卡
& "d:\HS4\HS2CharEdit\HS2CharEdit\bin\Release\net6.0-windows7.0\HS2CharEdit.exe" --validate "d:\HS4\out_card.png"
echo "Exit code: $LASTEXITCODE"
type "d:\HS4\out_card.chareditor_check.json"
```

**預期**：run_poc 已會產出 `out_card.chareditor_check.json`；用 `--validate` 再跑一次會用**編輯器本尊邏輯**覆寫/比對同一份報告，可對照與 Python 端是否一致。

---

## 6. 錯誤情境

- **檔案不存在**：會寫出含 `"error": "File not found: ..."` 的 JSON，exit code **1**。
- **不是有效 PNG 或沒有 IEND 後資料**：會寫出 `"error": "The PNG has no card data after IEND."`（或類似），exit code **1**。

---

## 快速對照

| 情境           | 指令                     | 預期 exit code | 預期 JSON 欄位                    |
|----------------|--------------------------|----------------|------------------------------------|
| 一般開啟       | `HS2CharEdit.exe`        | （不結束）     | -                                  |
| 驗證通過       | `--validate card.png`   | 0              | `chareditor_values_in_range: true` |
| 驗證失敗/錯誤  | `--validate card.png`   | 1              | `chareditor_values_in_range: false` 或 `error` |
