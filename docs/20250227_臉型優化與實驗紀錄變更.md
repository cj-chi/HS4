# 臉型優化與實驗紀錄變更（2025-02-27）

本檔整理「兩階段 Optuna／一次一維臉型優化、實驗紀錄與一鍵還原」之新增與變更，供專案紀錄與 GitHub 更新對照。

---

## 一、新增檔案

| 檔案 | 說明 |
|------|------|
| **run_optuna_face.py** | 兩階段 Optuna 臉型優化：起始點 ±90／步長 30 → 第一輪 → ±45／步長 15 → 第二輪。產出寫入 `output/experiments/optuna_<run_ts>/`，各 trial 含人物卡、截圖。僅呼叫既有模組，不修改既有程式。 |
| **run_onedim_face.py** | 一次一維臉型優化：每輪對 16 維依序掃描，每維只改該維；輪數、每輪範圍、步長為 CLI 參數（`--rounds`、`--range1`、`--step1`、`--range2`、`--step2`）。產出含人物卡、截圖、比較結果（誤差百分比）、manifest。 |
| **evaluate_face_guess.py** | 單一猜測評估並寫入比較紀錄：產卡 → 截圖 → MediaPipe → 寫入 `comparison_<run_ts>.json`（errors_percent、total_loss、card_path、screenshot_path）。僅呼叫既有模組，供 run_onedim_face 使用。 |
| **docs/臉型優化_一次一維_計畫.md** | 一次一維搜尋計畫書：目標、搜尋邏輯、可調參數、紀錄與產出管理、一鍵還原說明。 |

---

## 二、實驗紀錄與產出管理（已實作）

- **每次產出**：run_onedim_face 每個 trial 目錄（`round_<k>/dim_<name>/point_<i>/`）內含人物卡、截圖、**comparison_<run_ts>.json**（誤差以**百分比**表示）。
- **不覆寫**：實驗 ID 為 `onedim_<run_ts>` 或 `optuna_<run_ts>`，每次執行不同 run_ts，產出寫入獨立實驗目錄。
- **時間戳**：所有產出與紀錄檔名皆含 run_ts（如 `best_params_onedim_<run_ts>.json`、`manifest_<run_ts>.json`、`comparison_<run_ts>.json`）。
- **Manifest**：run_onedim_face 結束後寫入 `manifest_<run_ts>.json`，一覽產出與一鍵還原指令。

---

## 三、會動到 HS2 時的一鍵還原

- 臉型優化腳本僅寫入 `output/`，不寫入 HS2 安裝目錄。
- 若曾用 **hs2_photo_to_card_config.py set** 修改 BepInEx 的 RequestFile，還原指令：  
  **`python hs2_photo_to_card_config.py restore --hs2-root <HS2路徑>`**  
  （從該目錄下最新一份時間戳備份還原 `HS2.PhotoToCard.cfg`。）

---

## 四、已更新文件

| 檔案 | 變更摘要 |
|------|----------|
| **docs/既有已驗證腳本與流程.md** | 對照總表新增「兩階段 Optuna」「一次一維臉型優化」；§5 補上 run_optuna_face / run_onedim_face 入口與參數、紀錄與產出、一鍵還原說明。 |
| **docs/臉型優化_一次一維_計畫.md** | 補上「紀錄與產出管理」「會動到 HS2 時的一鍵還原」；單一猜測評估改為引用 evaluate_face_guess.evaluate_one_guess_and_record。 |
| **docs/臉型導入與反覆測試架構.md** | §13 補上一鍵還原指令與 run_onedim_face 的紀錄方式（卡／截圖／誤差百分比、時間戳、不覆寫）。 |
| **run_optuna_face.py** | docstring 註明產出與 run_ts、一鍵還原。 |
| **run_onedim_face.py** | docstring 註明每次產出、時間戳、不覆寫、一鍵還原；改用 evaluate_face_guess.evaluate_one_guess_and_record；寫入 manifest。 |

---

## 五、GitHub 更新要點

- **新增**：run_optuna_face.py、run_onedim_face.py、evaluate_face_guess.py、docs/臉型優化_一次一維_計畫.md、docs/20250227_臉型優化與實驗紀錄變更.md。
- **修改**：docs/既有已驗證腳本與流程.md、docs/臉型優化_一次一維_計畫.md、docs/臉型導入與反覆測試架構.md、run_optuna_face.py、run_onedim_face.py。
- **說明**：兩階段 Optuna 與一次一維兩種優化入口並存；實驗紀錄與產出含時間戳、不覆寫；比較結果以百分比紀錄；會動到 HS2 時一鍵還原為 hs2_photo_to_card_config.py restore。
