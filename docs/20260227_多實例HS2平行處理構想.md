# 多實例 HS2 平行處理構想

**日期**：2026-02-27  
**主旨**：150 個參數（或大量截圖）時，是否可開 N 個 HS2 平行處理；現有架構限制與可行做法紀錄。

---

## 1. 現有架構限制

- **一機一請求檔**：BepInEx 插件的 **RequestFile** 在 config 裡是**單一路徑**（如 `D:\HS4\output\load_card_request.txt`），插件只輪詢這一個檔。
- **截圖單一檔名**：插件將截圖寫入「與 request_file 同目錄」的 **`game_screenshot.png`**（見 `run_phase1.request_screenshot_and_wait`：`screenshot_path = request_file.parent / "game_screenshot.png"`）。
- 因此：一組「請求檔路徑 + 截圖路徑」對應一個 HS2 實例；要 N 個實例就需 N 組互不衝突的目錄／路徑。

---

## 2. 可行做法

### 做法一：N 份 HS2（或 N 個獨立遊戲目錄）

- 每份有**獨立的 BepInEx config**，例如：
  - 實例 0：RequestFile = `D:\HS4\output\instance_0\load_card_request.txt`
  - 實例 1：RequestFile = `D:\HS4\output\instance_1\load_card_request.txt`
  - …
- 各實例的插件只寫自己目錄下的 `game_screenshot.png`，互不干擾。
- **Python 端**：起 N 個 process（或每實例一 thread），每個負責：
  - 啟動對應的那份 HS2
  - 寫入該 instance 的 `load_card_request.txt`
  - 輪詢該目錄的 `game_screenshot.png`
- **150 個參數**可切給 N 個實例（例如每實例負責 150/N 張卡），即 N 個 HS2 平行處理。

### 做法二：只裝一份 HS2，改插件

- 讓插件支援「多組請求／多個輸出檔」（例如多個 RequestFile，或一個目錄內多個 request 檔對應不同 screenshot 檔名）。
- 再搭配多 process／多 thread 寫不同 request、讀不同 screenshot。
- 需改 C# 插件與 config，且 Unity 遊戲多不建議同一 process 內多線同時載卡／截圖，穩定性需實測。

### 資源與實務

- 每個 HS2 會吃不少 **RAM 與 GPU**，N 開多少要看機器（例如 2～4 個較常見，再上去需實測）。
- 若 150 個參數代表 150 張卡／150 次截圖，平行後總時間約可縮為約 1/N（不含啟動與 I/O）；單次啟動約 53 s 若每實例只做一次可攤掉。

---

## 3. 小結

- **有機會**開 N 個 HS2 平行處理大量參數。
- **目前程式**是「一機一請求檔一截圖」設計；要平行最直接是 **N 份遊戲目錄 + N 個 RequestFile 路徑**，Python 用多 process 各管一個 instance。
- 若不想複製多份 HS2，則需改 BepInEx 插件支援多組請求／多輸出，並自行評估穩定性與資源。

---

## 4. 設定腳本與一鍵回復

專案根目錄的 **`hs2_photo_to_card_config.py`** 負責「設定 RequestFile」與「還原 HS2 設定」：

- **設定**（會先對現有 cfg 做時間戳備份再寫入）：
  ```text
  python hs2_photo_to_card_config.py set --hs2-root D:\HS2 --instance 0
  python hs2_photo_to_card_config.py set --hs2-root D:\HS2_instance1 --instance 1
  ```
- **一鍵回復**：將指定 HS2 目錄的 `BepInEx\config\HS2.PhotoToCard.cfg` 從**最新一份**備份還原（可一次還原多個目錄）：
  ```text
  python hs2_photo_to_card_config.py restore --hs2-root D:\HS2 --hs2-root D:\HS2_instance1
  ```

備份檔名格式：`HS2.PhotoToCard.cfg.backup_<YYYYmmdd>_<HHMMSS>`，與原 cfg 同目錄。

**說明**：編排腳本 `run_two_instances_three_screenshots.py` 僅在文件或使用說明中指示使用者呼叫上述指令；不實作、也不重寫 INI 讀寫或還原邏輯。

---

## 5. 兩實例試跑

- **執行前**：先以 `hs2_photo_to_card_config.py set` 為兩份 HS2 分別設定 RequestFile（見 §4）。每份遊戲目錄只需設定一次；變更前會自動時間戳備份。
- **執行**：使用 **`run_two_instances_three_screenshots.py`**，傳入兩份 HS2 的 exe 路徑與卡牌（`--card` 單張重複 3 次，或 `--cards` 六張）。腳本僅編排：依序呼叫 `run_phase1.wait_for_ready_file`、`run_phase1.request_screenshot_and_wait`（每實例 3 次），不改寫既有邏輯。
- **還原**：若要還原 HS2 端 cfg，請用 **一鍵回復**：`python hs2_photo_to_card_config.py restore --hs2-root <路徑1> [--hs2-root <路徑2> ...]`。不在編排腳本內重寫還原。

範例：
```text
python hs2_photo_to_card_config.py set --hs2-root D:\HS2 --instance 0
python hs2_photo_to_card_config.py set --hs2-root D:\HS2_instance1 --instance 1
python run_two_instances_three_screenshots.py --exe0 D:\HS2\HoneySelect2.exe --exe1 D:\HS2_instance1\HoneySelect2.exe --card path\to\card.png
```

## 6. 相關檔案

- 既有流程與截圖入口：`docs/既有已驗證腳本與流程.md`
- 插件 RequestFile、game_ready.txt：`BepInEx_HS2_PhotoToCard/README.md`、`docs/如何啟動HS2.md`
- 請求檔與輪詢：`run_phase1.request_screenshot_and_wait`、`run_phase1.py`
- 設定／還原：`hs2_photo_to_card_config.py`（§4）
- 兩實例×各三截圖編排：`run_two_instances_three_screenshots.py`（§5）

---

## 7. 試跑中止紀錄（2026-02-27）

兩實例試跑已暫停，並還原對 HS2 的設定變更。原因：第二份 HS2（D:\HS2 - Copy）手動啟動也會卡在 Sideloader 掃描數千個 mods，無法在合理時間內進 title screen。詳見 **`docs/20260227_兩實例HS2_試跑中止紀錄.md`**。
