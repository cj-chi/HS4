# 既有已驗證腳本與流程（最大化沿用、不重寫）

本文件整理**已驗證過的**啟動 HS2、FOV／鏡頭、截圖、測試與驗證流程，後續腳本應**優先串接這些入口**，不重複實作。

**誤差顯示**：所有報告與輸出中的誤差一律以**百分比（%）**表示（表格欄位、摘要、JSON 內 `error_pct` / `errors_percent`）；`total_loss` 為加權分數，非百分比。

---

## 1. 對照總表

| 需求 | 已驗證入口 | 說明 |
|------|------------|------|
| **啟動 HS2** | `run_phase1_full.ps1`（改 `$Hs2Exe`）或 `run_phase1.py --launch-game <exe>` | `subprocess.Popen(exe)` + 等 `game_ready.txt`。見 `docs/如何啟動HS2.md`。 |
| **調 FOV／鏡頭** | **BepInEx 插件** `BepInEx_HS2_PhotoToCard` | **第一次截圖時**插件自動：相機目標設為頭部（`cf_J_Head`）、拉近 FOV 使臉約占畫面 35%，寫入 `game_screenshot_fov.txt`。**不需另寫 Python 調 FOV**。詳見 `docs/FOV調整與截圖構圖紀錄.md`。 |
| **截圖** | 插件讀取 `load_card_request.txt` → 載卡（僅臉）→ 截圖寫出 `game_screenshot.png`；Python 用 `run_phase1.request_screenshot_and_wait` 輪詢 | 請求檔路徑須與插件 **RequestFile** 一致（如 `D:\HS4\output\load_card_request.txt`）。 |
| **一輪測試（產卡＋截圖＋MediaPipe）** | `run_phase1_full.ps1` | 啟動 HS2 → 等 game_ready → 產卡 → 寫請求 → 等截圖（此時插件會自動調 FOV）→ MediaPipe 誤差。 |
| **一輪測試＋17 ratio 報告** | `run_phase1_then_17_report.ps1` | 僅串接 `run_phase1.py` + `report_17_ratio_mapping.py`，無重複邏輯。產卡／啟動／鏡頭／截圖／MediaPipe 見 `docs/臉型導入與反覆測試架構.md` §3.1。 |
| **17 ratio 誤差報告** | `report_17_ratio_mapping.py --target-image <原始.jpg> --screenshot <截圖.png> -o <報告>` 或 `--experiment-dir <round_0>` | 原始 JPG vs 遊戲截圖的 MediaPipe 誤差 %。見 `docs/17_ratio_to_hs2_slider_對照.md`。 |
| **新舊版 mapping 比對** | `run_compare_old_vs_new.ps1` 或 `compare_old_new_mediapipe.py`（可加 `--launch-game`） | 產兩張卡（舊版／新版）→ 各請求一張截圖 → 兩份 17 ratio 報告。 |
| **完整測試（舊 / 新 / 混）** | `compare_three_way_mediapipe.py`（可加 `--launch-game`） | 產三張卡（舊、新、混合 mapping）→ 各請求一張截圖 → 與原始 JPG 比對誤差 %，產出三欄誤差表與 total_loss。沿用 run_poc、request_screenshot_and_wait、run_report。 |

---

## 2. FOV／鏡頭（沿用插件，勿重寫）

- **誰做**：BepInEx 插件 `HS2PhotoToCardPlugin.cs`，在**第一次截圖**時執行。
- **做什麼**：取得頭部 `cf_J_Head` → 設 `TargetPos` 為頭 → yield 兩幀 → 依頭高像素算 FOV（臉約 35% 畫面高）→ `CameraFov = newFov`，寫入 `game_screenshot_fov.txt`，不還原。
- **文件**：`docs/FOV調整與截圖構圖紀錄.md`（除錯假設、時序、驗證 log、路徑）。
- **結論**：只要用「寫入請求檔 → 插件載卡＋截圖」這條路，**FOV 已包含在內**；`request_screenshot_for_card.py`、`run_phase1.py`、比對流程皆沿用同一插件，無需再寫調 FOV 的腳本。

---

## 3. 測試／驗證（沿用既有腳本）

- **全程無人工一輪**：`run_phase1_full.ps1`（改好 `$Hs2Exe`、`$TargetImage`、`$BaseCard`）。
- **同上＋17 項誤差報告**：`run_phase1_then_17_report.ps1`（可傳 `-Hs2Exe ""` 改為不啟動、手動開 HS2）。
- **單獨產報告**：跑完 phase1 或比對後，對該次 `round_0` 或指定截圖執行 `report_17_ratio_mapping.py`。
- **架構與名詞**：`docs/臉型導入與反覆測試架構.md` §3.1 既有流程對照、§15 驗證。

---

## 4. 新腳本應如何沿用

- **要啟動 HS2**：呼叫 `run_phase1.py` 的 `--launch-game` 或由 PS1 傳入 `$Hs2Exe`，並用同一套 `wait_for_ready_file(ready_file, timeout)`。
- **要截圖**：用 `run_phase1.request_screenshot_and_wait(card_path, request_file, dest_screenshot, ...)`；請求檔目錄與插件 RequestFile 一致，**FOV 由插件在第一次截圖時自動處理**。
- **要 MediaPipe／17 ratio**：用 `extract_face_ratios.extract_ratios` + `report_17_ratio_mapping.run_report` 或直接執行 `report_17_ratio_mapping.py`。

這樣可**最大化使用過去已經驗證過的腳本**，包含啟動、調 FOV（插件）與測試流程。
