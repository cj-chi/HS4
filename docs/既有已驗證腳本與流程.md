# 既有已驗證腳本與流程（最大化沿用、不重寫）

本文件整理**已驗證過的**啟動 HS2、FOV／鏡頭、截圖、測試與驗證流程，後續腳本應**優先串接這些入口**，不重複實作。

**誤差顯示**：所有報告與輸出中的誤差一律以**百分比（%）**表示（表格欄位、摘要、JSON 內 `error_pct` / `errors_percent`）；`total_loss` 為加權分數，非百分比。

---

## 1. 對照總表

| 需求 | 已驗證入口 | 說明 |
|------|------------|------|
| **啟動 HS2** | `run_phase1_full.ps1`（改 `$Hs2Exe`）或 `run_phase1.py --launch-game <exe>` | `subprocess.Popen(exe)` + 等 `game_ready.txt`。見 `docs/如何啟動HS2.md`。 |
| **調 FOV／鏡頭** | **BepInEx 插件** `BepInEx_HS2_PhotoToCard` | **第一次截圖時**插件自動：相機目標設為頭部（`cf_J_Head`）、拉近 FOV 使臉約占畫面 35%，寫入 `game_screenshot_fov.txt`。**不需另寫 Python 調 FOV**。詳見 `docs/FOV調整與截圖構圖紀錄.md`。 |
| **截圖** | 插件讀取 `load_card_request.txt` → 載卡（僅臉）→ 截圖寫出 `game_screenshot.png`；Python 用 `run_phase1.request_screenshot_and_wait` 輪詢 | 請求檔路徑須與插件 **RequestFile** 一致（如 `D:\HS4\output\load_card_request.txt`）。 |
| **一輪測試（產卡＋截圖＋MediaPipe）** | `run_phase1_full.ps1` | 啟動 HS2 → 等 game_ready → 產卡 → 寫請求 → 等截圖（此時插件會自動調 FOV）→ MediaPipe 誤差。 |
| **一輪測試＋17 ratio 報告** | `run_phase1_then_17_report.ps1` | 僅串接 `run_phase1.py` + `report_17_ratio_mapping.py`，無重複邏輯。產卡／啟動／鏡頭／截圖／MediaPipe 見 `docs/臉型導入與反覆測試架構.md` §3.1。 |
| **17 ratio 誤差報告** | `report_17_ratio_mapping.py --target-image <原始.jpg> --screenshot <截圖.png> -o <報告>` 或 `--experiment-dir <round_0>` | 原始 JPG vs 遊戲截圖的 MediaPipe 誤差 %。見 `docs/17_ratio_to_hs2_slider_對照.md`。 |
| **新舊版 mapping 比對** | `run_compare_old_vs_new.ps1` 或 `compare_old_new_mediapipe.py`（可加 `--launch-game`） | 產兩張卡（舊版／新版）→ 各請求一張截圖 → 兩份 17 ratio 報告。 |
| **完整測試（舊 / 新 / 混）** | `compare_three_way_mediapipe.py`（可加 `--launch-game`） | 產三張卡（舊、新、混合 mapping）→ 各請求一張截圖 → 與原始 JPG 比對誤差 %，產出三欄誤差表與 total_loss。沿用 run_poc、request_screenshot_and_wait、run_report。會產出執行時間紀錄：寫入 `compare_three_way_summary.json` 的 `execution_times` 與 `run_at_iso`，並另存 `Output/YYYYMMDD_HHMMSS_三向比對_執行時間.json`，供之後規劃與瓶頸分析參考。 |
| **兩階段 Optuna 臉型優化** | `run_optuna_face.py`（可加 `--launch-game`） | 起始點（JPG→MediaPipe→ratio_to_slider）→ 第一輪 Optuna（±90、步長 30）→ 第二輪（±45、步長 15）→ 輸出 best_params。沿用 extract_ratios、face_ratios_to_params、request_screenshot_and_wait、_compute_errors_and_loss。**一鍵回復**：若曾對 HS2 做過設定，還原用 `python hs2_photo_to_card_config.py restore --hs2-root <路徑>`。 |
| **一次一維臉型優化** | `run_onedim_face.py`（可加 `--launch-game`） | 一次只動一維，輪數／每輪範圍／步長為參數。每次產出：人物卡、截圖、比較結果（errors_percent 百分比）寫入各 trial 目錄；實驗 ID 與產出檔名皆含時間戳，不覆寫；manifest 一覽產出。一鍵還原：`hs2_photo_to_card_config.py restore --hs2-root <路徑>`。見 `docs/臉型優化_一次一維_計畫.md`。 |

---

## 2. FOV／鏡頭（沿用插件，勿重寫）

- **誰做**：BepInEx 插件 `HS2PhotoToCardPlugin.cs`，在**第一次截圖**時執行。
- **做什麼**：取得頭部 `cf_J_Head` → 設 `TargetPos` 為頭 → yield 兩幀 → 依頭高像素算 FOV（臉約 35% 畫面高）→ `CameraFov = newFov`，寫入 `game_screenshot_fov.txt`，不還原。
- **文件**：`docs/FOV調整與截圖構圖紀錄.md`（除錯假設、時序、驗證 log、路徑）。
- **結論**：只要用「寫入請求檔 → 插件載卡＋截圖」這條路，**FOV 已包含在內**；`request_screenshot_for_card.py`、`run_phase1.py`、比對流程皆沿用同一插件，無需再寫調 FOV 的腳本。

---

## 3. 測試／驗證（沿用既有腳本）

- **全程無人工一輪**：`run_phase1_full.ps1`（改好 `$Hs2Exe`、`$TargetImage`、`$BaseCard`）。
- **同上＋17 項誤差報告**：`run_phase1_then_17_report.ps1`（可傳 `-Hs2Exe ""` 改為不啟動、手動開 HS2）。
- **單獨產報告**：跑完 phase1 或比對後，對該次 `round_0` 或指定截圖執行 `report_17_ratio_mapping.py`。
- **架構與名詞**：`docs/臉型導入與反覆測試架構.md` §3.1 既有流程對照、§15 驗證。

---

## 4. 新腳本應如何沿用

- **要啟動 HS2**：呼叫 `run_phase1.py` 的 `--launch-game` 或由 PS1 傳入 `$Hs2Exe`，並用同一套 `wait_for_ready_file(ready_file, timeout)`。
- **要截圖**：用 `run_phase1.request_screenshot_and_wait(card_path, request_file, dest_screenshot, ...)`；請求檔目錄與插件 RequestFile 一致，**FOV 由插件在第一次截圖時自動處理**。
- **要 MediaPipe／17 ratio**：用 `extract_face_ratios.extract_ratios` + `report_17_ratio_mapping.run_report` 或直接執行 `report_17_ratio_mapping.py`。

這樣可**最大化使用過去已經驗證過的腳本**，包含啟動、調 FOV（插件）與測試流程。

---

## 5. 兩階段 Optuna 臉型優化（run_optuna_face.py）

- **入口**：`run_optuna_face.py --target-image <臉孔圖> --base-card <基底卡> [--launch-game <HS2.exe>] [--output-dir output] [--request-file ...] [--ready-timeout 180] [--screenshot-timeout 120] [--n-trials-stage1 80] [--n-trials-stage2 50]`
- **流程**：等 game_ready（或 `--launch-game` 啟動 HS2）→ 目標圖 `extract_ratios` + `face_ratios_to_params` 得起始 params → 第一輪 Optuna（每維 start±90、步長 30、clamp [-100,200]）→ 第二輪 Optuna（每維 best1±45、步長 15）→ 寫入 `output/experiments/<experiment_id>/best_params_stage2_<timestamp>.json`。
- **沿用**：僅呼叫既有模組（`extract_face_ratios.extract_ratios`、`ratio_to_slider.face_ratios_to_params`、`write_face_params_into_trailing`、`run_phase1.request_screenshot_and_wait`、`run_phase1._compute_errors_and_loss`），不修改既有程式。
- **一鍵回復**：本腳本僅寫入 `output/`，不寫入 HS2 安裝目錄。若曾用 `hs2_photo_to_card_config.py set` 設定 BepInEx 的 RequestFile，還原方式為：  
  `python hs2_photo_to_card_config.py restore --hs2-root <HS2路徑>`  
  與 `docs/如何啟動HS2.md` §7、`docs/臉型導入與反覆測試架構.md` §13 一致。
- **一次一維優化（參數化）**：`run_onedim_face.py`：一次只動一維，輪數／範圍／步長皆為 CLI 參數。  
  `run_onedim_face.py --target-image <臉孔圖> --base-card <基底卡> [--launch-game <exe>] [--rounds 2] [--range1 90] [--step1 30] [--range2 45] [--step2 15]`  
  計畫書：`docs/臉型優化_一次一維_計畫.md`。一鍵回復同上。
- **紀錄與產出**：每次評估產出人物卡、截圖、比較結果（誤差以**百分比**寫入 `comparison_<run_ts>.json`）；實驗 ID 含時間戳（`onedim_<run_ts>`），不覆寫舊實驗；產出與紀錄檔名皆含 `run_ts`；實驗目錄內有 `manifest_<run_ts>.json` 一覽。
- **一鍵還原（會動到 HS2 時）**：臉型優化腳本僅寫入 `output/`；若曾用 `hs2_photo_to_card_config.py set` 改過 BepInEx 設定，還原指令：`python hs2_photo_to_card_config.py restore --hs2-root <HS2路徑>`（從最新時間戳備份還原）。
