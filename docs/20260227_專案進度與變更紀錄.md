# 專案進度與變更紀錄（到目前為止）

**日期**：2026-02-27  
**主旨**：彙整至今完成的比對流程、執行時間分析、混合 mapping、誤差表示、文件與命名慣例、多實例構想及 GitHub 更新要點。

---

## 1. 比對流程（最大化沿用既有腳本）

- **兩向比對（舊 vs 新）**
  - 腳本：`compare_old_new_mediapipe.py`
  - 產兩張卡（舊版專案 run_poc、新版 run_poc + `--map ratio_to_slider_map_new_only.json`）→ 各請求一張 HS2 截圖 → 與原始 JPG 做 MediaPipe 誤差評分。
  - 可加 `--launch-game <HS2.exe>` 由腳本啟動遊戲並等 `game_ready.txt`。

- **三向比對（舊 / 新 / 混）**
  - 腳本：`compare_three_way_mediapipe.py`
  - 產三張卡：舊（HS4 - Copy (5) 的 run_poc）、新（run_poc --map new_only）、混（run_poc 預設 map，即 `ratio_to_slider_map.json` 混合版）→ 各請求一張截圖 → 以原始 JPG 為目標對三張截圖做 MediaPipe 誤差 %，產出三欄誤差表與 total_loss。
  - 沿用：`run_poc`、`run_phase1.request_screenshot_and_wait`、`run_phase1.wait_for_ready_file`、`extract_face_ratios.extract_ratios`、`report_17_ratio_mapping.run_report`。
  - FOV／鏡頭：由 BepInEx 插件在**第一次截圖時**自動調整，不需另寫 Python。

- **啟動 HS2**
  - `run_phase1.py --launch-game <exe>` 或 `run_phase1_full.ps1`（改 `$Hs2Exe`）；插件 RequestFile 須與腳本寫入的 `load_card_request.txt` 路徑一致。見 `docs/如何啟動HS2.md`、`docs/既有已驗證腳本與流程.md`。

---

## 2. Mapping：舊版、新版、混合

- **舊版**：HS4 - Copy (5) 的 `run_poc.py` + 舊 `ratio_to_slider_map.json`（17 項，含 face_width_to_height 等）。
- **新版**：HS4 的 `run_poc.py` + `ratio_to_slider_map_new_only.json`（16 項，face_width_to_height_lower = jaw_w/face_h 等）。
- **混合**：`build_hybrid_map.py` 依比對結果「該參數舊好用用舊、新好用用新」產出 `ratio_to_slider_map.json`（混合版），三向比對時用此 map 產混合卡。

---

## 3. 誤差表示

- **一律以百分比（%）表示**：所有報告與輸出中的誤差（表格欄位、摘要、JSON 內 `error_pct` / `errors_percent`）。
- `total_loss` 為加權分數，非百分比；表格與說明中註明「誤差單位：%」。

---

## 4. 實驗結論（三向比對與非線性）

- **非線性**：同一組 16 個 ratio 上，「誰的誤差最低」在舊／新／混三者間**因參數而異**；混合（每參數擇優）得到最佳 total_loss（例：646.29），印證 ratio→slider 為非線性。
- **報告**：`docs/20250227_實驗總結_三向比對與非線性結論.md`（結論、誤差表、報告一覽、GitHub 更新要點）。

---

## 5. 執行時間分析與記錄

- **實作**：`compare_three_way_mediapipe.py` 對每個步驟計時（單位 **s**），使用 `time.perf_counter()`，四捨五入小數 2 位。
- **步驟**：card_old、card_new、card_hybrid、launch_game、screenshot_old、screenshot_new、screenshot_hybrid、mediapipe_extract、mediapipe_report、total。`--skip-cards`／`--skip-screenshots` 時對應步驟記 `skipped: true` 或 duration_sec 0。
- **寫入**：
  - `compare_three_way_summary.json` 新增 `execution_times`（unit: "s", total_sec, steps）、`run_at_iso`。
  - 另存 `Output/YYYYMMDD_HHMMSS_三向比對_執行時間.json`（每次 run 一檔，內容含 run_at_iso、execution_times、target_image）。
- **終端**：印出「執行時間（單位：s）」摘要（各 step id + duration_sec s | total s）。
- **推定紀錄**：第一張截圖 57.28 s 推定為「啟動遊戲約 53 s、換人物與截圖約 3 s」；可寫入執行時間 JSON 的 `inferred_breakdown`，供之後規劃與瓶頸分析。見 `docs/總結與報告檔命名慣例.md`。

---

## 6. 總結與報告檔命名慣例

- **格式**：日期_主旨（日期 YYYYMMDD，主旨簡短說明）。
- **放置**：總結／架構類 → `docs/`；當次實驗產出／數值報告 → `Output/`；執行時間報告 → `Output/YYYYMMDD_HHMMSS_三向比對_執行時間.json`。
- **詳見**：`docs/總結與報告檔命名慣例.md`。

---

## 7. 多實例 HS2 平行處理構想

- **情境**：例如 150 個參數，是否可開 N 個 HS2 平行處理。
- **現有限制**：一機一請求檔（RequestFile 單一路徑）、截圖單一檔名（`game_screenshot.png`），一組路徑對應一實例。
- **做法一**：N 份 HS2（或 N 個獨立遊戲目錄），每份獨立 BepInEx config、不同 RequestFile 路徑（如 `output/instance_0/load_card_request.txt`），Python 多 process 各管一實例。
- **做法二**：只裝一份 HS2，改插件支援多組請求／多輸出；需改 C# 與 config，穩定性需實測。
- **資源**：每實例吃 RAM/GPU，N 開多少需依機器實測；啟動約 53 s 可每實例只做一次攤掉。
- **詳見**：`docs/20260227_多實例HS2平行處理構想.md`。

---

## 8. 文件與產出一覽

| 類型 | 檔名／位置 | 說明 |
|------|------------|------|
| 流程對照 | `docs/既有已驗證腳本與流程.md` | 啟動、FOV、截圖、比對、報告入口一覽 |
| 命名慣例 | `docs/總結與報告檔命名慣例.md` | 日期_主旨、放置位置、執行時間報告範例 |
| 實驗總結 | `docs/20250227_實驗總結_三向比對與非線性結論.md` | 非線性結論、誤差表、報告與 GitHub 要點 |
| 舊新 mapping | `docs/舊版與新版_MediaPipe_slider_mapping_比較.md` | 舊版 vs 新版 mapping 比較與使用方式 |
| 多實例構想 | `docs/20260227_多實例HS2平行處理構想.md` | N 實例 HS2 平行、架構限制與可行做法 |
| 本紀錄 | `docs/20260227_專案進度與變更紀錄.md` | 到目前為止的進度與變更彙整 |
| 三向比對報告 | `Output/compare_three_way_summary.json`、`.md` | 誤差 + execution_times、run_at_iso |
| 執行時間報告 | `Output/YYYYMMDD_HHMMSS_三向比對_執行時間.json` | 各步 duration_sec（s）、可含 inferred_breakdown |
| 其他 | `docs/如何啟動HS2.md`、`docs/FOV調整與截圖構圖紀錄.md`、`docs/17_ratio_to_hs2_slider_對照.md`、`docs/臉型導入與反覆測試架構.md` 等 | 啟動、FOV、17 ratio 對照、架構與名詞 |

---

## 9. GitHub 更新要點

- **README／專案說明**：可補充「三向比對證明 ratio→slider 非線性；混合 mapping 可改善 total_loss；誤差以 % 表示；三向比對產出執行時間紀錄與另存 *_執行時間.json」。
- **腳本**：`compare_three_way_mediapipe.py`、`compare_old_new_mediapipe.py`、`build_hybrid_map.py`、`report_17_ratio_mapping.py`，及既有 run_poc、run_phase1 流程。
- **文件**：連結 `docs/既有已驗證腳本與流程.md`、`docs/20250227_實驗總結_三向比對與非線性結論.md`、`docs/總結與報告檔命名慣例.md`、`docs/20260227_多實例HS2平行處理構想.md`、`docs/20260227_專案進度與變更紀錄.md`，報告檔命名採「日期_主旨」以利整理。
