# 實驗前檢查與待釐清事項

本文對應架構文件「一輪一次／一輪兩次」簡化階段，**只做檢查與釐清，不寫實驗主程式碼**。若缺元件則補齊（可下載的依賴先安裝）。

---

## 一、必要元件檢查

### 1. Python 依賴（可下載安裝）

| 項目 | 狀態 | 說明 |
|------|------|------|
| `requirements.txt` | ✅ 存在 | Pillow, mediapipe, numpy, msgpack |
| 實際安裝 | ⚠️ 需確認 | 跑「一輪一次」前需 MediaPipe；未裝可執行下方指令 |

**若尚未安裝完整依賴，可執行：**

```bash
pip install -r requirements.txt
```

（若只想快速產卡、不跑 MediaPipe，可用 `requirements-minimal.txt` + run_poc `--mock-face`，但實驗架構需要真實 MediaPipe，建議裝完整版。）

---

### 2. 既有腳本與資料（專案內已有）

| 項目 | 狀態 | 備註 |
|------|------|------|
| `ratio_to_slider_map.json` | ✅ 存在 | 含 calibration、game_slider_range [-100, 200] |
| `extract_face_ratios.py` → `extract_ratios` | ✅ 存在 | MediaPipe 臉部比例 |
| `read_hs2_card.py` → `read_trailing_data`, `find_iend_in_bytes` | ✅ 存在 | 讀卡 trailing |
| `write_face_params_to_card.py` → `write_face_params_into_trailing` | ✅ 存在 | 寫入臉參、與產卡相容 |
| `run_poc.py`（ratio→params 邏輯） | ✅ 存在 | 尚未抽出為 `face_ratios_to_params`，架構建議共用 |
| `validate_mediapipe.py` | ✅ 存在 | 比對原始圖與截圖的 MediaPipe；架構可沿用或擴充 |

---

### 3. BepInEx 載卡＋截圖插件

| 項目 | 狀態 | 說明 |
|------|------|------|
| 專案目錄 `BepInEx_HS2_PhotoToCard` | ✅ 已補齊 | 已新增 `.csproj`、`PluginInfo.cs`、`HS2PhotoToCardPlugin.cs`（讀請求檔 → LoadFileLimited 僅臉 → Reload → 截圖） |
| 主插件類別 | ✅ 已實作 | 依 `MD FILE/plans/bepinex_自動載卡截圖_6f5ae78b.plan.md` 實作；設定檔可指定請求檔路徑，截圖寫入同目錄 `game_screenshot.png` |
| 遊戲端 BepInEx 5.x | ⚠️ 需使用者確認 | 需已安裝於 HS2 遊戲目錄（如 D:\hs2） |
| 編譯 | ⚠️ 需遊戲 DLL | 需本機有 HS2 的 `HS2_Data\Managed` 或將 `Assembly-CSharp.dll` 等複製到 `BepInEx_HS2_PhotoToCard\refs\`，詳見 `BepInEx_HS2_PhotoToCard\README.md` |

**結論**：插件**原始碼已就緒**，無現成可下載的編譯包；需在本機用遊戲 DLL 編譯後，將 `HS2.PhotoToCard.dll` 複製到遊戲 `BepInEx\plugins\`。  
在插件尚未編譯/部署前，一輪一次／一輪兩次可先用**手動載卡＋手動截圖**或 **mock 截圖**跑通整條鏈路。

---

### 4. Python 端「寫請求檔＋輪詢截圖」

| 項目 | 狀態 | 說明 |
|------|------|------|
| `auto_photo_to_card.py` 寫入 `load_card_request.txt` | ❌ 未實作 | 計畫有寫，目前仍為「請使用者手動載卡、手動存 game_screenshot.png」 |
| 輪詢 `game_screenshot.png`（60–120s） | ❌ 未實作 | 同上 |

與架構的「截圖自動化」一致：等 BepInEx 插件就緒後，再由 `run_experiment`（或共用模組）寫請求檔並輪詢；一輪多次時為「依序寫請求 → 等截圖 → 複製到 screenshot_<i>.png → 下一張」。

---

### 5. 尚未存在的檔案（依架構後續實作）

- `run_experiment.py`（主入口）
- `blackbox.py`（`get_next_guesses` 介面與 stub：一輪一次 [input]、一輪兩次 [input, input+10]）
- `backup_utils.py`（寫入 HS2 前備份；目前實驗寫出在 output/，可不先實作）
- 共用 `face_ratios_to_params`（可從 run_poc 抽出，如 `ratio_to_slider.py`）

---

## 二、概念是否有問題

- **一輪一次**：黑盒子 output = input，只驗證「第一輪起點 → 產卡 → 截圖 → MediaPipe → Loss」整條鏈。概念正確，且可先用手動/mock 截圖驗證。
- **一輪兩次**：黑盒子回傳 [input, input+10]，驗證同輪 N=2 的產卡、截圖、MediaPipe×2、Loss×2。概念正確；與架構「每輪 N 組猜測」一致。
- **依賴 BepInEx**：要「零手動」必須有插件；插件未完成前，用約定路徑（如手動存成 `round_0/screenshots/screenshot_00.png`）即可開發與除錯。

---

## 三、若缺元件就「下載」的對應動作

| 缺什麼 | 動作 |
|--------|------|
| Python 依賴（mediapipe 等） | 執行 `pip install -r requirements.txt` |
| BepInEx 載卡+截圖插件 | **無可下載成品**；需在 `BepInEx_HS2_PhotoToCard` 內**實作**主類別 + .csproj，並編譯後放到遊戲 `BepInEx/plugins` |
| 遊戲 Managed DLL（編譯插件用） | 需本機有 HS2 安裝（如 `D:\hs2\HS2_Data\Managed`），或將 `Assembly-CSharp.dll` 等複製到專案 `refs/` |

---

## 四、重大問題要釐清

以下在實作 `run_experiment` / 截圖自動化前建議先定案。

1. **請求檔與截圖路徑（一輪 N 張）**  
   架構：請求檔一行寫卡路徑；截圖固定檔名如 `game_screenshot.png`。一輪多張時是否為：**依序**「寫請求檔 → 等截圖出現 → 複製到 `screenshots/screenshot_<i>.png` → 再寫下一張卡的請求」？若是，需約定插件「讀取後刪除或清空請求檔」避免重複載入，並約定 Python 輪詢「檔案存在且修改時間在寫入請求之後」再複製。

2. **產出卡路徑與遊戲讀取**  
   產出卡在 `output/experiments/<id>/round_<k>/cards/card_<i>.png`，請求檔需寫**絕對路徑**。遊戲/BepInEx 能否讀取 `d:\HS4\output\...` 下的檔案？若遊戲只讀特定目錄（如 `UserData\chara\female\`），是否要先複製到該目錄再寫請求路徑？若複製到 HS2 目錄，需在架構中加上「寫入前備份」（backup_utils）。

3. **輸入路徑統一**  
   架構寫 `src/`、臉型 `9081374d2d746daf66024acde36ada77`、基底卡 `AI_191856.png`。專案內有 `SRC\`、有根目錄或他處的 `AI_191856.png`。要統一為小寫 `src/` 還是沿用 `SRC`？預設基底卡路徑是 `src/AI_191856.png` 還是 `AI_191856.png`（專案根目錄）？

4. **達標門檻**  
   「每項誤差 ≤10%」已定；**總 loss** 達標門檻是否要訂一個數值（例如總 loss < 某值即停）？還是僅用「無任一維度 e ≥ 10%」即視為達標？

5. **BepInEx 與 HS2 路徑**  
   使用者本機 HS2 與 BepInEx 的安裝路徑（例如 `D:\hs2`）；請求檔/截圖的約定目錄是與 `output/` 一致還是遊戲目錄下的某處？需在文件或 CLI 參數中固定（如 `--request-file`、`--screenshot-output`）。

6. **一輪兩次「input+10」的範圍**  
   架構已寫滑桿 clamp 在 -100～200；是否所有 59 個臉參都適用此範圍？若有參數不同範圍，stub 的「+10」是否要依 `ratio_to_slider_map.json` 的 `game_slider_range` 或各參數個別 clamp？

---

以上：**必要元件**已列於一、**概念**無明顯問題、**可下載的**僅 Python 依賴（`pip install -r requirements.txt`），其餘為專案內實作或本機路徑設定。**重大待釐清**已列於四，建議在寫實驗主程式前先決定。
